<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>CalendarService.ts</title><script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script><script src="https://unpkg.com/@babel/standalone/babel.min.js"></script><script src="./build/entry.js"></script><script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous"><link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css"><link type="text/css" rel="stylesheet" href="styles/app.min.css"><link type="text/css" rel="stylesheet" href="styles/iframe.css"><link type="text/css" rel="stylesheet" href=""><script async defer src="https://buttons.github.io/buttons.js"></script></head><body class="layout small-header"><div id="stickyNavbarOverlay"></div><div class="top-nav"><div class="inner"><a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false"><span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span></a><div class="logo"></div><div class="menu"><div class="navigation"><a href="index.html" class="link" >Documentation </a></div></div></div></div><div id="main"><div class="sidebar " id="sidebarNav" ><nav><h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Classes</h3><ul><li><a href="CalendarService.html">CalendarService</a></li><li><a href="CreationError.html">CreationError</a></li><li><a href="FetchError.html">FetchError</a></li><li><a href="Log.html">Log</a></li><li><a href="ParameterError.html">ParameterError</a></li><li><a href="SheetInterpreter.html">SheetInterpreter</a></li></ul><h3>Interfaces</h3><ul><li><a href="IRuleTable.html">IRuleTable</a></li></ul><h3>Global</h3><ul><li><a href="global.html#CalFactory">CalFactory</a></li></ul></div></nav></div><div class="core" id="main-content-wrapper"><div class="content"><header class="page-title"><p>Source</p><h1>CalendarService.ts</h1></header><section><article><pre class="prettyprint source linenums"><code>import{ Log} from './Log';import{ CreationError, FetchError} from './Error';import{ role} from './common';declare const exports: typeof import('./Error') &amp; typeof import('./common') &amp; typeof import('./Log');exports.Log;exports.CreationError;exports.FetchError;export type Calendar=GoogleAppsScript.Calendar.Calendar;export type AclRule=GoogleAppsScript.Calendar.Schema.AclRule;export type CalendarWithRules=Calendar &amp;{ rules: AclRule[], name: string, id: string, toString: ()=>string;};export class CalendarService{ private count=0; private calendars: CalendarWithRules[]; private calendarToString=(name: string, id: string, ruleCnt: number)=>(()=>`"calendar":{ "name":"${name}", "id":"${id}"} with ${ruleCnt} rules.`); constructor(){ this.calendars=this.fetchAllCalendars(); Log.log("[Info] A new instance of CalendarService has been created. calendars: %s", this.calendars);} toJson(): string{ return `{\n${this.calendars.map(cal=>( `\t"${cal.name}":{\n\t\t"id":"${cal.id}",\n\t\t"rules":{"${cal.rules.map(rule=>`\n\t\t\t"${rule.scope?.value}":"${rule.role}"`).join(",")}\n\t}` )).join(",\n")}\n}`;} private fetchAllCalendars(): CalendarWithRules[]{ try{ this.count++; const _calendars=CalendarApp.getAllOwnedCalendars()?.map((calendar)=>{ this.count++; const calId=calendar.getId(); const calName=calendar.getName(); const aclItems=Calendar.Acl!.list(calId).items ?? []; return Object.assign( calendar, { rules: aclItems, name: calName, id: calId, toString: this.calendarToString(calName, calId, aclItems.length)} );}); if (!_calendars?.length){ // if undefined or 0. throw new FetchError( `Failed to fetch calenders from Calender API.` );} return _calendars;} catch (err){ throw new FetchError( `Failed to fetch calenders (or AclRules) from Calender API. details: ${err}` );}} renew(): CalendarWithRules[]{ this.calendars=this.fetchAllCalendars(); return this.calendars;} getAllCalendars(): CalendarWithRules[]{ return this.calendars;} getCalendarById(id: string): CalendarWithRules{ for (const calendar of this.calendars){ if (calendar.id===id){ return calendar;}} throw new FetchError(`Failed to get the calendar; There seems no calendar with ID ${id} in your scope.`);} getCalendarByName(name: string): CalendarWithRules{ for (const calendar of this.calendars){ if (calendar.name===name){ return calendar;}} throw new FetchError(`Failed to get the calendar; There seems no calendar with name ${name} in this account's scope.`);} getAclRule(_calendar: string | CalendarWithRules, userMailAddress: string): AclRule | undefined{ const calendar=(typeof _calendar==="string") ? this.getCalendarById(_calendar) : _calendar; const aclItems=calendar.rules; if (!aclItems){ Log.log("[Error] Something is wrong. Failed to get the ACL rule of %s. @CalendarService.getAclRule", calendar.name); return undefined;} if (aclItems.length===0){ Log.log("[Notice] Calendar %s does not have any Acl rules. @CalendarService.getAclRule", calendar.name); return undefined;} for (const item of aclItems){ if (item.scope?.value===userMailAddress){ return item;}} Log.log(`[Notice] Calendar ${calendar.name} does not have an Acl rule for ${userMailAddress}. Returns as "none" access role. @CalendarService.getAclRule`); return{ id: `user:${userMailAddress}`, kind: "calendar#aclRule", role: "none", scope:{ type: "user", value: userMailAddress}};} createCalendarWithName(calendarName: string): CalendarWithRules{ this.count++; const _newCalendar=CalendarApp.createCalendar(calendarName); if (_newCalendar){ const newCalendar=Object.assign(_newCalendar, { rules: [] as AclRule[], name: _newCalendar.getName(), id: _newCalendar.getId(), toString: this.calendarToString(_newCalendar.getName(), _newCalendar.getId(), 0)} ); this.calendars.push(newCalendar); Log.log("[Info] Success @setNewCalendar; Calendar: %s", newCalendar); return newCalendar;} else{ throw new CreationError(`Failed to create a new calendar: ${calendarName}`);}} getOrCreateCalendarWithName(calendarName: string): CalendarWithRules{ try{ const existingCal=this.getCalendarByName(calendarName); Log.log(`[Info] @setNewCalendar; calendar ${calendarName} exists. Skipping...`); return existingCal;} catch (e){ // If the calendar is not found. this.count++; const _newCalendar=CalendarApp.createCalendar(calendarName); if (!!_newCalendar){ const newCalendar=Object.assign(_newCalendar, { rules: [] as AclRule[], name: _newCalendar.getName(), id: _newCalendar.getId(), toString: this.calendarToString(_newCalendar.getName(), _newCalendar.getId(), 0)} ); this.calendars.push(newCalendar); Log.log("[Info] Success @setNewCalendar; Calendar: %s", newCalendar); return newCalendar;} else{ throw new CreationError(`Failed to create a new calendar: ${calendarName}`);}}} createAclRule(calendar: string | CalendarWithRules, userMailAddress: string, role: role): AclRule{ try{ const calendarId=typeof calendar==="string" ? calendar : calendar.id; const rule=this.getAclRule(calendarId, userMailAddress); if (rule?.role===role){ Log.log( "[Notice] @createAclRule; The exact Role already exists:{ %s: %s}", userMailAddress, JSON.stringify(role) ); return rule;} else{ const aclParam={ "scope":{ "type": "user", "value": userMailAddress}, "role": role}; this.count++; const newAcl=Calendar.Acl!.insert(aclParam, calendarId); if (!newAcl){ throw new FetchError(`Failed to create a new ACL rule for ${userMailAddress}`);} Log.log("[Info] Success @createAclRule; Acl: %s",{ newAcl}); return newAcl;}} catch (err){ if (err instanceof Error){ throw err;} else{ throw new Error(JSON.stringify({ err}));}}} getCount(){ return this.count;}}</code></pre></article></section></div><footer class="footer"><div class="content has-text-centered"><p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a></p><p class="sidebar-created-by"><a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a>provided with <i class="fas fa-heart"></i>by <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a></p></div></footer></div><div id="side-nav" class="side-nav"></div></div><script src="scripts/app.min.js"></script><script>PR.prettyPrint();</script><script src="scripts/linenumber.js"></script></body></html>
