<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>SheetInterpreter.ts</title><script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script><script src="https://unpkg.com/@babel/standalone/babel.min.js"></script><script src="./build/entry.js"></script><script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous"><link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css"><link type="text/css" rel="stylesheet" href="styles/app.min.css"><link type="text/css" rel="stylesheet" href="styles/iframe.css"><link type="text/css" rel="stylesheet" href=""><script async defer src="https://buttons.github.io/buttons.js"></script></head><body class="layout small-header"><div id="stickyNavbarOverlay"></div><div class="top-nav"><div class="inner"><a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false"><span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span></a><div class="logo"></div><div class="menu"><div class="navigation"><a href="index.html" class="link" >Documentation </a></div></div></div></div><div id="main"><div class="sidebar " id="sidebarNav" ><nav><h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Classes</h3><ul><li><a href="CalendarService.html">CalendarService</a></li><li><a href="CreationError.html">CreationError</a></li><li><a href="FetchError.html">FetchError</a></li><li><a href="Log.html">Log</a></li><li><a href="ParameterError.html">ParameterError</a></li><li><a href="SheetInterpreter.html">SheetInterpreter</a></li></ul><h3>Interfaces</h3><ul><li><a href="IRuleTable.html">IRuleTable</a></li></ul><h3>Global</h3><ul><li><a href="global.html#CalFactory">CalFactory</a></li></ul></div></nav></div><div class="core" id="main-content-wrapper"><div class="content"><header class="page-title"><p>Source</p><h1>SheetInterpreter.ts</h1></header><section><article><pre class="prettyprint source linenums"><code>import type{ role} from './common';import{ ParameterError, FetchError} from './Error';import{ Log} from './Log';declare const exports: typeof import('./Error') &amp; typeof import('./common') &amp; typeof import('./Log');exports.FetchError;exports.ParameterError;exports.Log;export type Sheet=GoogleAppsScript.Spreadsheet.Sheet;interface IRuleTable{ [calendarName: string]: { mail: string, role: role;}[]}export class SheetInterpreter{ private readonly ROLE_LIST: role[]=["none", "freeBusyReader", "reader", "writer", "owner"]; private table: IRuleTable; private calendarNamesInSheet: Array&lt;string>; constructor(sheetId: string, sheetName: string, termTable:{ [key: string]: role;}){ Object.entries(termTable).forEach(([key, value])=>{ // param check if (!this.ROLE_LIST.includes(value)){ throw new ParameterError("termTable", "role", `${value}`);}}); const spreadSheet=SpreadsheetApp.openById(sheetId); if (!spreadSheet){ throw new ParameterError("sheet_id", "valid SpreadSheet Id", "invalid SpreadSheet Id");} const sheet=spreadSheet.getSheetByName(sheetName); if (!sheet){ throw new FetchError(`There is no sheet named "${sheetName}" . Sheet not found.`);} const data=this.retrieveArrayFromSheet(sheet); this.calendarNamesInSheet=data[0].filter(i=>i); this.table=data.map((row, i, sheet)=>{ // Iterates over the rows; Returns IRoleTable[][] let acc: IRuleTable={}; row.forEach((cell, j)=>{ // Iterates over the cell for each row. if (i===0){ return;} // The first row of each cell is the header. i.e. calendar name. if (j===0){ return;} // The first column of each cell is the user email address. const calendarName=sheet[0][j]; const userMail=row[0]; // same as `sheet[i][0]` const role=cell in termTable ? `${termTable[cell]}` as const : "none"; const existingRole=acc[calendarName] ?? []; acc={ ...acc, [calendarName]: [...existingRole as{ mail: string, role: role;}[],{ mail: userMail, role: role}]};}); return acc;}).reduce((acc, ruleTable)=>{ // Iterates over IRoleTable[][]; Returns IRuleTable[]. Object.entries(ruleTable).forEach(([calendarName, rules])=>{ acc[calendarName]=[...(acc[calendarName] ?? []), ...rules];}); return acc;}); Log.log("[Info] A new instance of SheetInterpreter is created. ruleTable: %s, calendarNamesInSheet: %s", JSON.stringify(this.table), JSON.stringify(this.calendarNamesInSheet));} private retrieveArrayFromSheet(sheet: Sheet): string[][]{ return sheet.getRange(1, 1, sheet.getLastRow(), sheet.getLastColumn()) .getValues() .filter((i)=>~~i?.length >1); // not `false`, `null`, `NaN`, `""`, `0`, `Infinit`, `[]`, `{}`, nor `undefined`} getRuleTable(): IRuleTable{ return this.table;} getCalendarNamesInSheet(): Array&lt;string>{ return this.calendarNamesInSheet;}}</code></pre></article></section></div><footer class="footer"><div class="content has-text-centered"><p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a></p><p class="sidebar-created-by"><a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a>provided with <i class="fas fa-heart"></i>by <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a></p></div></footer></div><div id="side-nav" class="side-nav"></div></div><script src="scripts/app.min.js"></script><script>PR.prettyPrint();</script><script src="scripts/linenumber.js"></script></body></html>
